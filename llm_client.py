import requests
import asyncio
import json
import aiohttp
from config import OPENROUTER_API_URL, OPENROUTER_API_KEY, OPENROUTER_MODEL
import logging
from rddm_info import get_rddm_knowledge
from session_manager import PostSize

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class LLMClient:
    def __init__(self, api_url=OPENROUTER_API_URL, api_key=OPENROUTER_API_KEY, model=OPENROUTER_MODEL):
        self.api_url = api_url
        self.api_key = api_key
        self.model = model
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json",
            "HTTP-Referer": "https://rddm-bot.app",
            "X-Title": "–†–î–î–ú –ë–æ—Ç"
        }
    
    async def generate_from_template(self, template_post, topic, post_size=PostSize.LARGE, language="ru"):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–∞ –∏ —Ç–µ–º—ã."""
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –†–î–î–ú
        rddm_info = get_rddm_knowledge(topic)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å—Ç–∞ (–≤ —Å–∏–º–≤–æ–ª–∞—Ö)
        size_range = self._get_size_range(post_size)
        min_size, max_size = map(int, size_range.split('-'))
        
        system_prompt = """–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç SMM, —Å–æ–∑–¥–∞—é—â–∏–π –ø–æ—Å—Ç—ã –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –æ—Ç –∏–º–µ–Ω–∏ –†–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –¥–µ—Ç–µ–π –∏ –º–æ–ª–æ–¥—ë–∂–∏ "–î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö" (–†–î–î–ú). 
        –ü–∏—à–∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω—ã–º —è–∑—ã–∫–æ–º. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤."""
        
        user_prompt = f"""–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –ø–æ—Å—Ç–∞:

{template_post}

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–æ–≤—ã–π –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É: {topic}

–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –æ –†–î–î–ú:
{rddm_info}

–í–ê–ñ–ù–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –ü–û –î–õ–ò–ù–ï! 
–ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç {min_size} –¥–æ {max_size} —Å–∏–º–≤–æ–ª–æ–≤. –¢—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞!

–í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –ò—Å–ø–æ–ª—å–∑—É–π Markdown-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è Telegram: **–∂–∏—Ä–Ω—ã–π**, `–∫–æ–¥`, ```–±–ª–æ–∫ –∫–æ–¥–∞```, ~~–∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π~~, ||—Å–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç||
2. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤
3. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ", "–∏ –ø—Ä–æ—á–µ–µ", –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
4. –ü–∏—à–∏ –æ—Ç –∏–º–µ–Ω–∏ –†–î–î–ú –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ–º —Ç–æ–Ω–µ
5. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–æ–∑–∞, –ø–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞
6. –ù–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –≤—Å–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –†–î–î–ú, —É–ø–æ–º–∏–Ω–∞–π —Ç–æ–ª—å–∫–æ 2-3 —É–º–µ—Å—Ç–Ω—ã–µ –∫ —Ç–µ–º–µ
7. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
8. –†–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è
9. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ (—Å–º–∞–π–ª–∏–∫–∏), –µ—Å–ª–∏ –æ–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ—Å—Ç–∞"""
        
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π —è–∑—ã–∫
        if language.lower() != "ru":
            user_prompt += f"\n–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ {language} —è–∑—ã–∫–µ."
            
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        generated_text = await self._send_request_async(system_prompt, user_prompt)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä—É
        return self._enforce_size_limits(generated_text, min_size, max_size)
    
    async def generate_without_template(self, topic, post_size=PostSize.LARGE, language="ru"):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –±–µ–∑ —à–∞–±–ª–æ–Ω–∞, —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–º–µ."""
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –†–î–î–ú
        rddm_info = get_rddm_knowledge(topic)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å—Ç–∞ (–≤ —Å–∏–º–≤–æ–ª–∞—Ö)
        size_range = self._get_size_range(post_size)
        min_size, max_size = map(int, size_range.split('-'))
        
        system_prompt = """–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç SMM, —Å–æ–∑–¥–∞—é—â–∏–π –ø–æ—Å—Ç—ã –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –æ—Ç –∏–º–µ–Ω–∏ –†–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –¥–µ—Ç–µ–π –∏ –º–æ–ª–æ–¥—ë–∂–∏ "–î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö" (–†–î–î–ú).
        –ü–∏—à–∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω—ã–º —è–∑—ã–∫–æ–º. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤."""
        
        user_prompt = f"""–°–æ–∑–¥–∞–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –Ω–∞ —Ç–µ–º—É: {topic}
        
–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –æ –†–î–î–ú:
{rddm_info}

–í–ê–ñ–ù–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –ü–û –î–õ–ò–ù–ï! 
–ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç {min_size} –¥–æ {max_size} —Å–∏–º–≤–æ–ª–æ–≤. –¢—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞!

–í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –ò—Å–ø–æ–ª—å–∑—É–π Markdown-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è Telegram: **–∂–∏—Ä–Ω—ã–π**, `–∫–æ–¥`, ```–±–ª–æ–∫ –∫–æ–¥–∞```, ~~–∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π~~, ||—Å–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç||
2. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤
3. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ", "–∏ –ø—Ä–æ—á–µ–µ", –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
4. –ü–∏—à–∏ –æ—Ç –∏–º–µ–Ω–∏ –†–î–î–ú –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ–º —Ç–æ–Ω–µ 
5. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–æ–∑–∞, –ø–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞
6. –ù–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –≤—Å–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –†–î–î–ú, —É–ø–æ–º–∏–Ω–∞–π —Ç–æ–ª—å–∫–æ 2-3 —É–º–µ—Å—Ç–Ω—ã–µ –∫ —Ç–µ–º–µ
7. –ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ, –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å –∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
8. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
9. –†–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è
10. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ (—Å–º–∞–π–ª–∏–∫–∏), –µ—Å–ª–∏ –æ–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ—Å—Ç–∞"""
        
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π —è–∑—ã–∫
        if language.lower() != "ru":
            user_prompt += f"\n–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ {language} —è–∑—ã–∫–µ."
            
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        generated_text = await self._send_request_async(system_prompt, user_prompt)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä—É
        return self._enforce_size_limits(generated_text, min_size, max_size)
    
    async def modify_post(self, current_post, modification_request, language="ru"):
        """–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ—Å—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–ø—Ä–æ—Å—É."""
        system_prompt = """–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç SMM, —Å–æ–∑–¥–∞—é—â–∏–π –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—â–∏–π –ø–æ—Å—Ç—ã –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –æ—Ç –∏–º–µ–Ω–∏ –†–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –¥–µ—Ç–µ–π –∏ –º–æ–ª–æ–¥—ë–∂–∏ "–î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö" (–†–î–î–ú).
        –ü–∏—à–∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω—ã–º —è–∑—ã–∫–æ–º. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤."""
        
        user_prompt = f"""–í–æ—Ç —Ç–µ–∫—É—â–∏–π –ø–æ—Å—Ç:

{current_post}

–í–Ω–µ—Å–∏ —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: {modification_request}

–í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –°–æ—Ö—Ä–∞–Ω–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç—É –∂–µ –¥–ª–∏–Ω—É —á—Ç–æ –∏ —É –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π Markdown-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è Telegram: **–∂–∏—Ä–Ω—ã–π**, `–∫–æ–¥`, ```–±–ª–æ–∫ –∫–æ–¥–∞```, ~~–∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π~~, ||—Å–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç||
3. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤
4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ", "–∏ –ø—Ä–æ—á–µ–µ", –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
5. –ü–∏—à–∏ –æ—Ç –∏–º–µ–Ω–∏ –†–î–î–ú –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ–º —Ç–æ–Ω–µ
6. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–æ–∑–∞, –ø–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞
7. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
8. –†–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è
9. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ (—Å–º–∞–π–ª–∏–∫–∏), –µ—Å–ª–∏ –æ–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ—Å—Ç–∞"""
        
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π —è–∑—ã–∫
        if language.lower() != "ru":
            user_prompt += f"\n–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ {language} —è–∑—ã–∫–µ."
            
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        generated_text = await self._send_request_async(system_prompt, user_prompt)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç—É –∂–µ –¥–ª–∏–Ω—É
        current_length = len(current_post)
        return self._enforce_size_limits(generated_text, current_length * 0.8, current_length * 1.2)
    
    def _get_size_range(self, post_size):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Å—Ç–∞."""
        if post_size == PostSize.SMALL:
            return "200-400"
        elif post_size == PostSize.MEDIUM:
            return "400-800"
        else:  # PostSize.LARGE
            return "800-1200"
    
    def _enforce_size_limits(self, text, min_size, max_size):
        """–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–Ω—ã–º –ª–∏–º–∏—Ç–∞–º –ø–æ —Ä–∞–∑–º–µ—Ä—É."""
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫, —Å–æ—Ö—Ä–∞–Ω—è—è –∞–±–∑–∞—Ü—ã
        paragraphs = text.split('\n\n')
        text = '\n\n'.join([' '.join(p.split()) for p in paragraphs])
        
        text_length = len(text)
        logger.info(f"–î–ª–∏–Ω–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: {text_length} —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∏–º–∏—Ç: {min_size}-{max_size})")
        
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—á–µ –º–∏–Ω–∏–º—É–º–∞, –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        if text_length < min_size:
            additional_text = "\n\nüëã –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–∏–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º –∏ —Å—Ç–∞–Ω—å—Ç–µ —á–∞—Å—Ç—å—é **–î–≤–∏–∂–µ–Ω–∏—è –ø–µ—Ä–≤—ã—Ö**! –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ [–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ](https://–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ) –∏ –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö."
            text += additional_text[:int(min_size - text_length)]
            logger.info(f"–¢–µ–∫—Å—Ç –±—ã–ª —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–º, –¥–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ. –ù–æ–≤–∞—è –¥–ª–∏–Ω–∞: {len(text)}")
        
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ –º–∞–∫—Å–∏–º—É–º–∞, –æ–±—Ä–µ–∑–∞–µ–º –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        if text_length > max_size:
            # –ù–∞–π–¥–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–Ω–∞–∫ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞
            cutoff_text = text[:int(max_size)]
            last_period = max(cutoff_text.rfind('.'), cutoff_text.rfind('!'), cutoff_text.rfind('?'))
            
            if last_period > 0:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç –ª–∏ –æ–±—Ä–µ–∑–∫–∞ Markdown-—Ä–∞–∑–º–µ—Ç–∫—É
                text_to_check = text[:last_period + 1]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã Markdown (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏ –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ)
                if text_to_check.count('**') % 2 != 0:
                    # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏–π —Å–∏–º–≤–æ–ª
                    last_bold = text_to_check.rfind('**')
                    if last_bold > 0:
                        text_to_check = text_to_check[:last_bold] + text_to_check[last_bold+2:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –±—ç–∫—Ç–∏–∫–∏ –¥–ª—è –∫–æ–¥–∞
                if text_to_check.count('`') % 2 != 0:
                    last_backtick = text_to_check.rfind('`')
                    if last_backtick > 0:
                        text_to_check = text_to_check[:last_backtick] + text_to_check[last_backtick+1:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–æ–π–Ω—ã–µ –±—ç–∫—Ç–∏–∫–∏ –¥–ª—è –±–ª–æ–∫–∞ –∫–æ–¥–∞
                triple_backticks = text_to_check.count('```')
                if triple_backticks % 2 != 0:
                    last_triple = text_to_check.rfind('```')
                    if last_triple > 0:
                        text_to_check = text_to_check[:last_triple] + text_to_check[last_triple+3:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤–æ–π–Ω—ã–µ —Ç–∏–ª—å–¥—ã –¥–ª—è –∑–∞—á–µ—Ä–∫–Ω—É—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                if text_to_check.count('~~') % 2 != 0:
                    last_strikethrough = text_to_check.rfind('~~')
                    if last_strikethrough > 0:
                        text_to_check = text_to_check[:last_strikethrough] + text_to_check[last_strikethrough+2:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤–æ–π–Ω—ã–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —á–µ—Ä—Ç—ã –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                if text_to_check.count('||') % 2 != 0:
                    last_spoiler = text_to_check.rfind('||')
                    if last_spoiler > 0:
                        text_to_check = text_to_check[:last_spoiler] + text_to_check[last_spoiler+2:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç—Å—è –ª–∏ —Å—Å—ã–ª–∫–∞
                if text_to_check.count('[') != text_to_check.count(']') or text_to_check.count('(') != text_to_check.count(')'):
                    # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–ª–Ω—É—é —Å—Å—ã–ª–∫—É
                    last_complete_link_end = text_to_check.rfind(')')
                    if last_complete_link_end > 0:
                        # –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ—Ç–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É
                        for i in range(last_complete_link_end - 1, -1, -1):
                            if text_to_check[i] == '(':
                                # –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é –∫–≤–∞–¥—Ä–∞—Ç–Ω—É—é —Å–∫–æ–±–∫—É
                                for j in range(i - 1, -1, -1):
                                    if text_to_check[j] == '[':
                                        # –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç j –¥–æ last_complete_link_end
                                        text_to_check = text_to_check[:last_complete_link_end + 1]
                                        break
                                break
                
                text = text_to_check
                logger.info(f"–¢–µ–∫—Å—Ç –±—ã–ª —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º, –æ–±—Ä–µ–∑–∞–Ω –¥–æ {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
            else:
                # –ï—Å–ª–∏ –Ω–µ—Ç –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–µ–∑–∞–µ–º
                text = cutoff_text + "..."
                logger.info(f"–¢–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω –±–µ–∑ —É—á–µ—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        return text
    
    async def _send_request_async(self, system_prompt, user_prompt):
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ OpenRouter API."""
        try:
            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAI API
            payload = {
                "model": self.model,
                "messages": [
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                "max_tokens": 1024,
                "temperature": 0.7
            }
            
            logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenRouter –¥–ª—è –º–æ–¥–µ–ª–∏ {self.model}")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º aiohttp –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    self.api_url, 
                    json=payload, 
                    headers=self.headers,
                    timeout=aiohttp.ClientTimeout(total=60)  # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç
                ) as response:
                    if response.status != 200:
                        error_text = await response.text()
                        logger.error(f"–û—à–∏–±–∫–∞ API: {response.status}, {error_text}")
                        return self._get_fallback_response(user_prompt)
                    
                    result = await response.json()
                    
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã OpenAI API
                    if "choices" in result and len(result["choices"]) > 0:
                        message = result["choices"][0]["message"]
                        if message and "content" in message:
                            return message["content"]
            
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞")
            return self._get_fallback_response(user_prompt)
            
        except (aiohttp.ClientError, asyncio.TimeoutError) as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenRouter API: {e}")
            return self._get_fallback_response(user_prompt)
    
    def _get_fallback_response(self, user_prompt):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–ª—É—à–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API."""
        logger.info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞")
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏–ª —Ä–∞–±–æ—Ç—É
        if "—à–∞–±–ª–æ–Ω—É" in user_prompt:
            return "üëã –ü—Ä–∏–≤–µ—Ç –æ—Ç **–†–î–î–ú**!\n\n–ú—ã —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –≤ –Ω–∞—à–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ. –î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö - —ç—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ –∫–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –ø—Ä–æ—è–≤–∏—Ç—å —Å–µ–±—è –∏ —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –±–æ–ª—å—à–æ–π –¥—Ä—É–∂–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã.\n\n‚ú® –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –Ω–∞–º –∏ –æ—Ç–∫—Ä—ã–≤–∞–π –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—è!\n\n–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ [–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ](https://–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ) üöÄ"
        else:
            return "üéâ **–†–î–î–ú** –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤—Å–µ—Ö –Ω–∞ –Ω–∞—à–µ –Ω–æ–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ!\n\n–ë—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω–æ –∏ –≤–µ—Å–µ–ª–æ. –ñ–¥–µ–º —Ç–µ–±—è –≤ –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ.\n\nüìç –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ [–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ](https://–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ) üí´" 