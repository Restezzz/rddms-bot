import requests
import asyncio
import json
import aiohttp
from config import (
    OPENROUTER_API_URLS, OPENROUTER_API_KEY, OPENROUTER_MODEL, OPENROUTER_HEADERS,
    BACKUP_MODELS, REQUEST_TIMEOUT, MAX_RETRIES, ALLOWED_REFERERS, HTTP_PROXY, HTTPS_PROXY,
    DIRECT_IP_URLS
)
import logging
from rddm_info import get_rddm_knowledge
from session_manager import PostSize
import os
from urllib3.exceptions import InsecureRequestWarning
import urllib3
import time
import random
from urllib.parse import urlparse

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è SSL –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
urllib3.disable_warnings(InsecureRequestWarning)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class LLMClient:
    def __init__(self, api_urls=OPENROUTER_API_URLS, api_key=OPENROUTER_API_KEY, model=OPENROUTER_MODEL, headers=OPENROUTER_HEADERS):
        self.api_urls = api_urls
        self.api_key = api_key
        self.model = model
        self.backup_models = BACKUP_MODELS
        self.headers = headers.copy()
        self.headers.update({
            "Content-Type": "application/json",
        })
        
        # –ü—Ä—è–º—ã–µ IP URL –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ DNS
        self.direct_ip_urls = DIRECT_IP_URLS
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        self.http_proxy = HTTP_PROXY or os.environ.get('HTTP_PROXY')
        self.https_proxy = HTTPS_PROXY or os.environ.get('HTTPS_PROXY')
        
        # –¢–∞–π–º–∞—É—Ç—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        self.request_timeout = REQUEST_TIMEOUT
        self.max_retries = MAX_RETRIES
        
        # –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä—Ä–µ—Ä–æ–≤
        self.referers = ALLOWED_REFERERS
    
    async def generate_from_template(self, template_post, topic, post_size=PostSize.LARGE, language="ru"):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–∞ –∏ —Ç–µ–º—ã."""
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –†–î–î–ú
        rddm_info = get_rddm_knowledge(topic)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å—Ç–∞ (–≤ —Å–∏–º–≤–æ–ª–∞—Ö)
        size_range = self._get_size_range(post_size)
        min_size, max_size = map(int, size_range.split('-'))
        
        system_prompt = """–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç SMM, —Å–æ–∑–¥–∞—é—â–∏–π –ø–æ—Å—Ç—ã –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –æ—Ç –∏–º–µ–Ω–∏ –†–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –¥–µ—Ç–µ–π –∏ –º–æ–ª–æ–¥—ë–∂–∏ "–î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö" (–†–î–î–ú). 
        –ü–∏—à–∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω—ã–º —è–∑—ã–∫–æ–º. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤."""
        
        user_prompt = f"""–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –ø–æ—Å—Ç–∞:

{template_post}

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–æ–≤—ã–π –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É: {topic}

–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –æ –†–î–î–ú:
{rddm_info}

–í–ê–ñ–ù–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –ü–û –î–õ–ò–ù–ï! 
–ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç {min_size} –¥–æ {max_size} —Å–∏–º–≤–æ–ª–æ–≤. –¢—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞!

–í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è Telegram (–±—É–¥–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ HTML): 
   **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** - –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö —Ñ—Ä–∞–∑
   `–∫–æ–¥` - –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
   ```–±–ª–æ–∫ –∫–æ–¥–∞``` - –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞ –∏–ª–∏ —Ü–∏—Ç–∞—Ç
   ~~–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç~~ - –¥–ª—è –ø–µ—Ä–µ—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è
   ||—Å–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç|| - –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å–ø–æ–π–ª–µ—Ä–æ–≤
   [—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏](URL) - –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫
2. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤
3. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ", "–∏ –ø—Ä–æ—á–µ–µ", –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
4. –ü–∏—à–∏ –æ—Ç –∏–º–µ–Ω–∏ –†–î–î–ú –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ–º —Ç–æ–Ω–µ
5. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–æ–∑–∞, –ø–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞
6. –ù–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –≤—Å–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –†–î–î–ú, —É–ø–æ–º–∏–Ω–∞–π —Ç–æ–ª—å–∫–æ 2-3 —É–º–µ—Å—Ç–Ω—ã–µ –∫ —Ç–µ–º–µ
7. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
8. –†–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è
9. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ (—Å–º–∞–π–ª–∏–∫–∏), –µ—Å–ª–∏ –æ–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ—Å—Ç–∞"""
        
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π —è–∑—ã–∫
        if language.lower() != "ru":
            user_prompt += f"\n–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ {language} —è–∑—ã–∫–µ."
            
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        generated_text = await self._send_request_async(system_prompt, user_prompt)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä—É
        return self._enforce_size_limits(generated_text, min_size, max_size)
    
    async def generate_without_template(self, topic, post_size=PostSize.LARGE, language="ru"):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –±–µ–∑ —à–∞–±–ª–æ–Ω–∞, —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–º–µ."""
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –†–î–î–ú
        rddm_info = get_rddm_knowledge(topic)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å—Ç–∞ (–≤ —Å–∏–º–≤–æ–ª–∞—Ö)
        size_range = self._get_size_range(post_size)
        min_size, max_size = map(int, size_range.split('-'))
        
        system_prompt = """–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç SMM, —Å–æ–∑–¥–∞—é—â–∏–π –ø–æ—Å—Ç—ã –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –æ—Ç –∏–º–µ–Ω–∏ –†–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –¥–µ—Ç–µ–π –∏ –º–æ–ª–æ–¥—ë–∂–∏ "–î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö" (–†–î–î–ú).
        –ü–∏—à–∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω—ã–º —è–∑—ã–∫–æ–º. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤."""
        
        user_prompt = f"""–°–æ–∑–¥–∞–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –Ω–∞ —Ç–µ–º—É: {topic}
        
–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –æ –†–î–î–ú:
{rddm_info}

–í–ê–ñ–ù–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –ü–û –î–õ–ò–ù–ï! 
–ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç {min_size} –¥–æ {max_size} —Å–∏–º–≤–æ–ª–æ–≤. –¢—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞!

–í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è Telegram (–±—É–¥–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ HTML): 
   **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** - –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö —Ñ—Ä–∞–∑
   `–∫–æ–¥` - –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
   ```–±–ª–æ–∫ –∫–æ–¥–∞``` - –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞ –∏–ª–∏ —Ü–∏—Ç–∞—Ç
   ~~–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç~~ - –¥–ª—è –ø–µ—Ä–µ—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è
   ||—Å–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç|| - –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å–ø–æ–π–ª–µ—Ä–æ–≤
   [—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏](URL) - –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫
2. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤
3. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ", "–∏ –ø—Ä–æ—á–µ–µ", –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
4. –ü–∏—à–∏ –æ—Ç –∏–º–µ–Ω–∏ –†–î–î–ú –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ–º —Ç–æ–Ω–µ 
5. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–æ–∑–∞, –ø–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞
6. –ù–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –≤—Å–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –†–î–î–ú, —É–ø–æ–º–∏–Ω–∞–π —Ç–æ–ª—å–∫–æ 2-3 —É–º–µ—Å—Ç–Ω—ã–µ –∫ —Ç–µ–º–µ
7. –ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ, –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å –∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
8. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
9. –†–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è
10. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ (—Å–º–∞–π–ª–∏–∫–∏), –µ—Å–ª–∏ –æ–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ—Å—Ç–∞"""
        
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π —è–∑—ã–∫
        if language.lower() != "ru":
            user_prompt += f"\n–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ {language} —è–∑—ã–∫–µ."
            
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        generated_text = await self._send_request_async(system_prompt, user_prompt)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä—É
        return self._enforce_size_limits(generated_text, min_size, max_size)
    
    async def modify_post(self, current_post, modification_request, language="ru"):
        """–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ—Å—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–ø—Ä–æ—Å—É."""
        system_prompt = """–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç SMM, —Å–æ–∑–¥–∞—é—â–∏–π –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—â–∏–π –ø–æ—Å—Ç—ã –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –æ—Ç –∏–º–µ–Ω–∏ –†–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –¥–µ—Ç–µ–π –∏ –º–æ–ª–æ–¥—ë–∂–∏ "–î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö" (–†–î–î–ú).
        –ü–∏—à–∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω—ã–º —è–∑—ã–∫–æ–º. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤."""
        
        user_prompt = f"""–í–æ—Ç —Ç–µ–∫—É—â–∏–π –ø–æ—Å—Ç:

{current_post}

–í–Ω–µ—Å–∏ —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: {modification_request}

–í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –°–æ—Ö—Ä–∞–Ω–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç—É –∂–µ –¥–ª–∏–Ω—É —á—Ç–æ –∏ —É –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è Telegram (–±—É–¥–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ HTML): 
   **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** - –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö —Ñ—Ä–∞–∑
   `–∫–æ–¥` - –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
   ```–±–ª–æ–∫ –∫–æ–¥–∞``` - –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞ –∏–ª–∏ —Ü–∏—Ç–∞—Ç
   ~~–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç~~ - –¥–ª—è –ø–µ—Ä–µ—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è
   ||—Å–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç|| - –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å–ø–æ–π–ª–µ—Ä–æ–≤
   [—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏](URL) - –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫
3. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤
4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ", "–∏ –ø—Ä–æ—á–µ–µ", –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
5. –ü–∏—à–∏ –æ—Ç –∏–º–µ–Ω–∏ –†–î–î–ú –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –Ω–æ –Ω–µ —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ–º —Ç–æ–Ω–µ
6. –ò–∑–±–µ–≥–∞–π –æ—Ñ–∏—Ü–∏–æ–∑–∞, –ø–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞
7. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
8. –†–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è
9. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ (—Å–º–∞–π–ª–∏–∫–∏), –µ—Å–ª–∏ –æ–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ—Å—Ç–∞"""
        
        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π —è–∑—ã–∫
        if language.lower() != "ru":
            user_prompt += f"\n–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ {language} —è–∑—ã–∫–µ."
            
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        generated_text = await self._send_request_async(system_prompt, user_prompt)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç—É –∂–µ –¥–ª–∏–Ω—É
        current_length = len(current_post)
        return self._enforce_size_limits(generated_text, current_length * 0.8, current_length * 1.2)
    
    def _get_size_range(self, post_size):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Å—Ç–∞."""
        if post_size == PostSize.SMALL:
            return "200-400"
        elif post_size == PostSize.MEDIUM:
            return "400-800"
        else:  # PostSize.LARGE
            return "800-1200"
    
    def _enforce_size_limits(self, text, min_size, max_size):
        """–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–Ω—ã–º –ª–∏–º–∏—Ç–∞–º –ø–æ —Ä–∞–∑–º–µ—Ä—É."""
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫, —Å–æ—Ö—Ä–∞–Ω—è—è –∞–±–∑–∞—Ü—ã
        paragraphs = text.split('\n\n')
        text = '\n\n'.join([' '.join(p.split()) for p in paragraphs])
        
        text_length = len(text)
        logger.info(f"–î–ª–∏–Ω–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: {text_length} —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∏–º–∏—Ç: {min_size}-{max_size})")
        
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—á–µ –º–∏–Ω–∏–º—É–º–∞, –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        if text_length < min_size:
            additional_text = "\n\nüëã –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–∏–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º –∏ —Å—Ç–∞–Ω—å—Ç–µ —á–∞—Å—Ç—å—é **–î–≤–∏–∂–µ–Ω–∏—è –ø–µ—Ä–≤—ã—Ö**! –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ [–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ](https://–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ) –∏ –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö."
            text += additional_text[:int(min_size - text_length)]
            logger.info(f"–¢–µ–∫—Å—Ç –±—ã–ª —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–º, –¥–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ. –ù–æ–≤–∞—è –¥–ª–∏–Ω–∞: {len(text)}")
        
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ –º–∞–∫—Å–∏–º—É–º–∞, –æ–±—Ä–µ–∑–∞–µ–º –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        if text_length > max_size:
            # –ù–∞–π–¥–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–Ω–∞–∫ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞
            cutoff_text = text[:int(max_size)]
            last_period = max(cutoff_text.rfind('.'), cutoff_text.rfind('!'), cutoff_text.rfind('?'))
            
            if last_period > 0:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç –ª–∏ –æ–±—Ä–µ–∑–∫–∞ Markdown-—Ä–∞–∑–º–µ—Ç–∫—É
                text_to_check = text[:last_period + 1]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã Markdown (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏ –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ)
                if text_to_check.count('**') % 2 != 0:
                    # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏–π —Å–∏–º–≤–æ–ª
                    last_bold = text_to_check.rfind('**')
                    if last_bold > 0:
                        text_to_check = text_to_check[:last_bold] + text_to_check[last_bold+2:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –±—ç–∫—Ç–∏–∫–∏ –¥–ª—è –∫–æ–¥–∞
                if text_to_check.count('`') % 2 != 0:
                    last_backtick = text_to_check.rfind('`')
                    if last_backtick > 0:
                        text_to_check = text_to_check[:last_backtick] + text_to_check[last_backtick+1:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–æ–π–Ω—ã–µ –±—ç–∫—Ç–∏–∫–∏ –¥–ª—è –±–ª–æ–∫–∞ –∫–æ–¥–∞
                triple_backticks = text_to_check.count('```')
                if triple_backticks % 2 != 0:
                    last_triple = text_to_check.rfind('```')
                    if last_triple > 0:
                        text_to_check = text_to_check[:last_triple] + text_to_check[last_triple+3:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤–æ–π–Ω—ã–µ —Ç–∏–ª—å–¥—ã –¥–ª—è –∑–∞—á–µ—Ä–∫–Ω—É—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                if text_to_check.count('~~') % 2 != 0:
                    last_strikethrough = text_to_check.rfind('~~')
                    if last_strikethrough > 0:
                        text_to_check = text_to_check[:last_strikethrough] + text_to_check[last_strikethrough+2:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤–æ–π–Ω—ã–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —á–µ—Ä—Ç—ã –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                if text_to_check.count('||') % 2 != 0:
                    last_spoiler = text_to_check.rfind('||')
                    if last_spoiler > 0:
                        text_to_check = text_to_check[:last_spoiler] + text_to_check[last_spoiler+2:]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç—Å—è –ª–∏ —Å—Å—ã–ª–∫–∞
                if text_to_check.count('[') != text_to_check.count(']') or text_to_check.count('(') != text_to_check.count(')'):
                    # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–ª–Ω—É—é —Å—Å—ã–ª–∫—É
                    last_complete_link_end = text_to_check.rfind(')')
                    if last_complete_link_end > 0:
                        # –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ—Ç–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É
                        for i in range(last_complete_link_end - 1, -1, -1):
                            if text_to_check[i] == '(':
                                # –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é –∫–≤–∞–¥—Ä–∞—Ç–Ω—É—é —Å–∫–æ–±–∫—É
                                for j in range(i - 1, -1, -1):
                                    if text_to_check[j] == '[':
                                        # –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç j –¥–æ last_complete_link_end
                                        text_to_check = text_to_check[:last_complete_link_end + 1]
                                        break
                                break
                
                text = text_to_check
                logger.info(f"–¢–µ–∫—Å—Ç –±—ã–ª —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º, –æ–±—Ä–µ–∑–∞–Ω –¥–æ {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
            else:
                # –ï—Å–ª–∏ –Ω–µ—Ç –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–µ–∑–∞–µ–º
                text = cutoff_text + "..."
                logger.info(f"–¢–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω –±–µ–∑ —É—á–µ—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        return text
    
    async def _send_request_async(self, system_prompt, user_prompt):
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ OpenRouter API —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ –ø—Ä–æ–∫—Å–∏."""
        # –í—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ URL –¥–ª—è API
        api_urls = self.api_urls.copy() if self.api_urls else []
        
        # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL API –¥–ª—è OpenRouter (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
        all_urls = api_urls.copy()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä—è–º—ã–µ IP URL –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        if hasattr(self, 'direct_ip_urls') and self.direct_ip_urls:
            all_urls.extend(self.direct_ip_urls)
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º IP-–∞–¥—Ä–µ—Å–∞ –Ω–∞–ø—Ä—è–º—É—é (–æ–±—Ö–æ–¥ DNS-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
            direct_ips = [
                # –§–æ—Ä–º–∞—Ç: https://IP/–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π_–ø—É—Ç—å_–∫_API
                "https://13.226.158.10/api/v1/chat/completions",  # IP –¥–ª—è openrouter.ai
                "https://13.226.158.23/api/v1/chat/completions"   # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π IP
            ]
            all_urls.extend(direct_ips)
        
        # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–æ—Ä—è–¥–æ–∫
        all_urls = list(dict.fromkeys(all_urls))
        
        # –ü—Ä–æ–∫—Å–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ None
        proxy_settings = None
        if self.http_proxy or self.https_proxy:
            proxy_settings = {
                "http": self.http_proxy,
                "https": self.https_proxy or self.http_proxy  # –ï—Å–ª–∏ https –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º http
            }
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏: {proxy_settings}")
        
        # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–±–æ—Ä–∞, –Ω–∞—á–∏–Ω–∞—è —Å –æ—Å–Ω–æ–≤–Ω–æ–π
        models_to_try = [self.model] + [m for m in self.backup_models if m != self.model]
        logger.info(f"–ú–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: {models_to_try}")
        
        # –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤
        headers_variations = []
        for referer in self.referers:
            headers_variations.append({
                "Content-Type": "application/json",
                "Authorization": f"Bearer {self.api_key}",
                "HTTP-Referer": referer,
                "X-Title": "RDDM Bot"
            })
        
        # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –º–æ–¥–µ–ª–∏
        for current_model in models_to_try:
            logger.info(f"–ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª—å: {current_model}")
            
            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
            payload = {
                "model": current_model,
                "messages": [
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                "max_tokens": 1024,
                "temperature": 0.7
            }
            
            # –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º URL –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
            random.shuffle(all_urls)
            random.shuffle(headers_variations)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
            for attempt_num, (url, headers) in enumerate([(u, h) for u in all_urls for h in headers_variations], 1):
                # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
                if attempt_num > self.max_retries * len(all_urls):
                    logger.warning(f"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –º–æ–¥–µ–ª–∏ {current_model}")
                    break
                    
                try:
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–æ–º–µ–Ω –∏–∑ URL –¥–ª—è DNS –ø—Ä–æ–≤–µ—Ä–∫–∏
                    domain = urlparse(url).netloc
                    logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt_num} —Å –º–æ–¥–µ–ª—å—é {current_model}: URL={url}, –¥–æ–º–µ–Ω={domain}")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, IP —ç—Ç–æ –∏–ª–∏ –¥–æ–º–µ–Ω
                    is_ip = all(c.isdigit() or c == '.' for c in domain.split(':')[0])
                    
                    # –ï—Å–ª–∏ IP –∞–¥—Ä–µ—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Host –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    if is_ip:
                        logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω IP –∞–¥—Ä–µ—Å: {domain}, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω Host –∑–∞–≥–æ–ª–æ–≤–æ–∫")
                    
                    # –¢–∞–π–º–∞—É—Ç –±–æ–ª—å—à–µ –¥–ª—è –ø–µ—Ä–≤—ã—Ö –ø–æ–ø—ã—Ç–æ–∫, –º–µ–Ω—å—à–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö
                    timeout_seconds = self.request_timeout if attempt_num <= 3 else self.request_timeout // 2
                    
                    # –ò–∑–º–µ—Ä—è–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
                    start_time = time.time()
                    
                    # –ü—Ä–æ–±—É–µ–º —Å SSL –∏ –±–µ–∑
                    for ssl_verify in [False, True]:
                        try:
                            # TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –ø—Ä–æ–∫—Å–∏
                            tcp_connector = aiohttp.TCPConnector(
                                ssl=ssl_verify,
                                force_close=True,  # –ó–∞–∫—Ä—ã–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                                ttl_dns_cache=300  # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ DNS –Ω–∞ 5 –º–∏–Ω—É—Ç
                            )
                            
                            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–∫—Å–∏ –∏ IP
                            headers_with_host = headers.copy()
                            if is_ip:
                                # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º IP, —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º Host –∑–∞–≥–æ–ª–æ–≤–æ–∫
                                headers_with_host["Host"] = "openrouter.ai"
                            
                            async with aiohttp.ClientSession(connector=tcp_connector) as session:
                                async with session.post(
                                    url, 
                                    json=payload, 
                                    headers=headers_with_host,
                                    proxy=self.https_proxy,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ aiohttp
                                    timeout=aiohttp.ClientTimeout(total=timeout_seconds, connect=timeout_seconds//2),
                                    ssl=ssl_verify
                                ) as response:
                                    elapsed_time = time.time() - start_time
                                    logger.info(f"–û—Ç–≤–µ—Ç: —Å—Ç–∞—Ç—É—Å={response.status}, –≤—Ä–µ–º—è={elapsed_time:.2f}—Å, SSL={ssl_verify}")
                                    
                                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º —Ç–µ–ª–∞
                                    if response.status == 200:
                                        try:
                                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º content-type
                                            content_type = response.headers.get('Content-Type', '')
                                            logger.info(f"–ü–æ–ª—É—á–µ–Ω Content-Type: {content_type}")
                                            
                                            # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                                            text = await response.text()
                                            
                                            # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
                                            try:
                                                if 'application/json' in content_type:
                                                    result = json.loads(text)
                                                else:
                                                    logger.warning(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π Content-Type: {content_type}, –ø—Ä–æ–±—É–µ–º –≤—Ä—É—á–Ω—É—é –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON")
                                                    if text.strip().startswith('{') and '"choices"' in text:
                                                        result = json.loads(text)
                                                    else:
                                                        logger.error(f"–û—Ç–≤–µ—Ç –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ JSON: {text[:200]}...")
                                                        continue
                                                
                                                if "choices" in result and len(result["choices"]) > 0:
                                                    message = result["choices"][0]["message"]
                                                    if message and "content" in message:
                                                        logger.info(f"–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç {url} —Å –º–æ–¥–µ–ª—å—é {current_model}")
                                                        return message["content"]
                                                    else:
                                                        logger.warning("API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ")
                                                else:
                                                    logger.warning("–í –æ—Ç–≤–µ—Ç–µ API –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç choices")
                                                    logger.debug(f"–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞: {str(result)[:200]}...")
                                            except json.JSONDecodeError as e:
                                                logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
                                                logger.debug(f"–ü—Ä–æ–±–ª–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç: {text[:200]}...")
                                        except Exception as e:
                                            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞: {type(e).__name__}: {str(e)}")
                                    
                                    # –õ–æ–≥–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                                    if response.status != 200:
                                        text = await response.text()
                                        logger.warning(f"–ù–µ—É–¥–∞—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å {response.status}: {text[:200]}...")
                                    
                                    # –ï—Å–ª–∏ 401, –ø—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø–æ–ø—ã—Ç–∫–∏
                                    if response.status == 401:
                                        logger.error("–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø–æ–ø—ã—Ç–∫–∏ —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º.")
                                        return self._get_fallback_response(user_prompt)
                            
                            # –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ –±–µ–∑ –æ—à–∏–±–æ–∫, –Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ - –∏–¥–µ–º –¥–∞–ª—å—à–µ
                            break
                            
                        except (aiohttp.ClientError, asyncio.TimeoutError) as e:
                            logger.warning(f"–û—à–∏–±–∫–∞ {type(e).__name__} –ø—Ä–∏ SSL={ssl_verify}: {str(e)}")
                            # –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                            if isinstance(e, aiohttp.ClientConnectorError):
                                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ {domain}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ–∫—Å–∏.")
                            elif isinstance(e, aiohttp.ServerDisconnectedError):
                                logger.error(f"–°–µ—Ä–≤–µ—Ä {domain} —Ä–∞–∑–æ—Ä–≤–∞–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.")
                            elif isinstance(e, aiohttp.ClientResponseError):
                                logger.error(f"–û—à–∏–±–∫–∞ HTTP: {e.status}, {e.message}")
                            elif isinstance(e, aiohttp.ClientPayloadError):
                                logger.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç {domain}")
                            elif isinstance(e, aiohttp.ClientOSError):
                                logger.error(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞: {str(e)}")
                            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ —Å–ª–µ–¥—É—é—â–∏–º ssl_verify –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
                    
                    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
                    await asyncio.sleep(1)
                    
                except Exception as e:
                    logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {type(e).__name__}: {str(e)}")
                    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –ø–æ–ø—ã—Ç–∫—É
                    await asyncio.sleep(1)
        
        # –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —á–µ—Ä–µ–∑ aiohttp –Ω–µ —É–¥–∞–ª–∏—Å—å, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π requests
        logger.info("–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —á–µ—Ä–µ–∑ aiohttp –Ω–µ —É–¥–∞–ª–∏—Å—å. –ü—Ä–æ–±—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π requests...")
        
        # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –∏ –ø—Ä–æ–±—É–µ–º –µ–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ requests
        last_model = models_to_try[-1]
        payload["model"] = last_model
        
        # –°–ø–∏—Å–æ–∫ URL –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ - —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ URL
        sync_urls = [
            "https://openrouter.ai/api/v1/chat/completions",
            "https://api.openrouter.ai/api/v1/chat/completions",
            "https://13.226.158.10/api/v1/chat/completions"
        ]
        
        for url in sync_urls:
            for headers in headers_variations[:2]:  # –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ –¥–≤–µ –≤–∞—Ä–∏–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                logger.info(f"–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ {url} —Å –º–æ–¥–µ–ª—å—é {last_model}")
                try:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, IP —ç—Ç–æ –∏–ª–∏ –¥–æ–º–µ–Ω
                    domain = urlparse(url).netloc
                    is_ip = all(c.isdigit() or c == '.' for c in domain.split(':')[0])
                    
                    # –ï—Å–ª–∏ IP –∞–¥—Ä–µ—Å, –¥–æ–±–∞–≤–ª—è–µ–º Host –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    if is_ip:
                        headers["Host"] = "openrouter.ai"
                    
                    # –ü—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å —Å –±–æ–ª—å—à–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º
                    response = requests.post(
                        url,
                        json=payload,
                        headers=headers,
                        proxies=proxy_settings,
                        timeout=self.request_timeout,  # –ë–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                        verify=False  # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É SSL
                    )
                    
                    logger.info(f"–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: —Å—Ç–∞—Ç—É—Å {response.status_code}")
                    
                    if response.status_code == 200:
                        try:
                            # –ü—Ä–æ–≤–µ—Ä–∫–∞ Content-Type
                            content_type = response.headers.get('Content-Type', '')
                            logger.info(f"–ü–æ–ª—É—á–µ–Ω Content-Type: {content_type}")
                            
                            # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                            text = response.text
                            
                            # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
                            try:
                                if 'application/json' in content_type:
                                    result = json.loads(text)
                                else:
                                    if text.strip().startswith('{') and '"choices"' in text:
                                        result = json.loads(text)
                                        logger.warning(f"–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω JSON —Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º Content-Type: {content_type}")
                                    else:
                                        logger.error(f"–û—Ç–≤–µ—Ç –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ JSON: {text[:200]}...")
                                        continue
                                
                                if result and "choices" in result and len(result["choices"]) > 0:
                                    message = result["choices"][0]["message"]
                                    if message and "content" in message:
                                        logger.info(f"–£—Å–ø–µ—à–Ω—ã–π —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –º–æ–¥–µ–ª—å—é {last_model}")
                                        return message["content"]
                                    else:
                                        logger.warning("API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ")
                            except json.JSONDecodeError as e:
                                logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
                                logger.debug(f"–ü—Ä–æ–±–ª–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç: {text[:200]}...")
                        except Exception as e:
                            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: {e}")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ {url}: {e}")
        
        # –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã
        logger.error("–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ API –Ω–µ—É–¥–∞—á–Ω—ã. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É.")
        return self._get_fallback_response(user_prompt)
    
    def _get_fallback_response(self, user_prompt):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–ª—É—à–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API."""
        logger.info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞")
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç —Å HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        if "—à–∞–±–ª–æ–Ω—É" in user_prompt:
            return "üëã –ü—Ä–∏–≤–µ—Ç –æ—Ç **–†–î–î–ú**!\n\n–ú—ã —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –≤ –Ω–∞—à–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ. **–î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö** - —ç—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ –∫–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –ø—Ä–æ—è–≤–∏—Ç—å —Å–µ–±—è –∏ —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –±–æ–ª—å—à–æ–π –¥—Ä—É–∂–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã.\n\n‚ú® –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –Ω–∞–º –∏ –æ—Ç–∫—Ä—ã–≤–∞–π –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—è!\n\n–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ [–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ](https://–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ) üöÄ"
        else:
            return "üéâ **–†–î–î–ú** –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤—Å–µ—Ö –Ω–∞ –Ω–∞—à–µ **–Ω–æ–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ**!\n\n–ë—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω–æ –∏ –≤–µ—Å–µ–ª–æ. –ñ–¥–µ–º —Ç–µ–±—è –≤ –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ.\n\nüìç –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ [–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ](https://–±—É–¥—å–≤–¥–≤–∏–∂–µ–Ω–∏–∏.—Ä—Ñ) ||–ø—Ä–∏—Ö–æ–¥–∏, –±—É–¥–µ—Ç —Å—é—Ä–ø—Ä–∏–∑!|| üí´" 